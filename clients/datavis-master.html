<!DOCTYPE html>
<meta charset="utf-8">
<html lang="en">

<style>

.title{
 color: #000;
 font: bold 48px monospace;
}

.line {
  fill: none;
  stroke: #000;
  stroke-width: 1.0px;
}

.line.disconnected{
  fill: none;
  stroke: #f00;
  stroke-width: 1.0px;
}

.button{
  fill: #000;
  stroke: #000;
  stroke-width: 1.0px;
}
.disabled {
  opacity:0.2;
}

.lab7{
  stroke:#88CCEE;
  fill:#88CCEE;
  color:#88CCEE;
}

.lab6{
  stroke:#882255;
  fill:#882255;
  color:#882255;
}

.lab8{
  stroke:#999933;
  fill:#999933;
  color:#999933;
}

.connectionText{
  font-weight: bold;
  font-size: 35px;
  font-family: monospace;
}
.error{
 opacity:0.2;

}
.not_error{
  font-weight: bold;
  font-size: 35px;
}

</style>
<body>
<div id="title" class="title">Lab-nanny v.0.5</div>
<div id="left_graphs" style="float:left">
<div id="connection_text_lab6" class="text lab6"></div>
<div id="graph0" class="aGraph" style="width:450px;"></div>
<div id="connection_text_lab7" class="text lab7"></div>
<div id="graph1" class="aGraph" style="width:450px;"></div>
</div>

<div id="toggle_buttons"></div>

<script src="//d3js.org/d3.v4.min.js"></script>
<script>
// n     = number of points
// dataX = data holder for the X channel
var n = 1000,
    periodicity=0.1,
    random = d3.randomNormal(0, .2),
    width = 400,
    height=50,
    margin = {top:0, right: 0, bottom: 20, left: 0},
    lab6dictionary={name:"lab6",pins:[11,13,17],analogchannels:["ch0","ch2"],
    data:{}, lines:{}, buttons:[],connection_text:[],
    graph_area:"#graph0",connection_text_area:"#connection_text_lab6"},
    lab7dictionary={name:"lab7",pins:[13,17,25],analogchannels:["ch0","ch2"],
    data:{}, lines:{}, buttons:[],connection_text:[],
    graph_area:"#graph1",connection_text_area:"#connection_text_lab7"},
    mainObj = {};

mainObj[lab6dictionary.name]=lab6dictionary;
mainObj[lab7dictionary.name]=lab7dictionary;



function sleep (time) {
  return new Promise((resolve) => setTimeout(resolve, time));
}

var connection = new WebSocket('ws://localhost:8001/client_ws');
//var connection = new WebSocket('ws://10.3.20.25:8001/ArduMon1');


var x = d3.scaleLinear()
    .domain([0, n - 1])
    .range([0, width-margin.right-margin.left]);
var y = d3.scaleLinear()
    .domain([0, 3.3])
    .range([height-margin.top-margin.bottom, 0]);

var line = d3.line()
        // assign the X function to plot our line as we wish
        .x(function(d,i) {
            // verbose logging to show what's actually being done
            //console.log('Plotting X value for data point: ' + d + ' using index: ' + i + ' to be at: ' + x(i) + ' using our xScale.');
            // return the X coordinate where we want to plot this datapoint
            return x(i);
        })
        .y(function(d) {
            // return the Y coordinate where we want to plot this datapoint
            return y(d);
        });



function send_data_back(lab,number,state){
  var message =  [lab,number,state];
  connection.send(message);
  return state
 }

function makeButton(lab,pinNumber, containerID){
   var buttonSVG = d3.select(containerID).append("svg:svg")
   .attr("width", 30)
   .attr("height", 60);
   var myButton = buttonSVG.append("rect")
          .attr("x",5)
          .attr("y",5)
          .attr("rx", 4)
          .attr("ry", 4)
          .attr("width", 20)
          .attr("height",20)
          .attr("class","button")
          .classed("disabled",true)
          .classed(lab,true)
          .attr("pinNumber",pinNumber)
          .on("click", function() {
            var AmIOn = d3.select(this).classed("disabled");
            d3.select(this).classed("disabled",AmIOn ? false : true);

            // Verbose output
            console.log(send_data_back(lab,pinNumber,+AmIOn));
   });
   var myText = buttonSVG.append("text")
          .attr("x",5)
          .attr("y",60)
          .attr("dy", "-1em")
          .text(pinNumber);
   return myButton
   }

function displayGraphExample(id,channel) {
   var graph = d3.select(id).append("svg:svg")
              .attr("width", width)
              .attr("height", height);
   g = graph.append("g").attr("transform","translate(" + margin.left + "," + margin.top + ")");
    var width1 = +width - margin.left - margin.right,
    height1 = +height - margin.top - margin.bottom;
   g.append("defs").append("clipPath")
    .attr("id", "clip")
    .append("rect")
    .attr("width", width1)
    .attr("height", height1);
   g.append("g")
    .attr("class", "axis axis--x")
    .attr("transform", "translate(0," + y(0) + ")")
    .call(d3.axisBottom(x));

     g.append("g")
      .attr("clip-path", "url(#clip)")
    myLine = g.append("path")
    .datum(d3.range(n).map(function(){return 1;})) //Initial data
    .attr("class", "line")
    .attr("d",line);

   //myLine = g.append("svg:path").attr("class","line").attr("d", line(data1));
        // or it can be done like this
        //graph.selectAll("path").data([data1]).enter().append("svg:path").attr("d", line);
   return myLine;

  }

function redrawWithoutAnimation(myLine, myData) {
            // static update without animation
            myLine.data([myData]) // set the new data
                .attr("d", line); // apply the new data values
        }

function add_data_to_buffer(buffer, data){
  buffer.push(data);
  buffer.shift();
  return buffer;
}

//
// MAIN CONSTRUCTOR:
//

// For each lab input
for(var lab in mainObj){
  //Create connection text
  mainObj[lab].connection_text = d3.select(mainObj[lab].connection_text_area)
          .classed("error",true)
          .classed("connectionText",true)
          .text(lab+ ' connected');
  //Create the buttons specified in the "pins" property and add it to the
  //"buttons" list
  mainObj[lab].pins.forEach(function(pin){
  var my_button = makeButton(mainObj[lab].name,pin,"#toggle_buttons");
  mainObj[lab].buttons.push(my_button);
  });
  // Also, for each channel, associate to it some line data (initialized to a
  // default value) and plot it in a certain "graph_area".
  mainObj[lab].analogchannels.forEach(function(channel){
  var line_data = d3.range(n).map(function(){return 1;}); //Default values
  var my_line = displayGraphExample(mainObj[lab].graph_area,channel);
  mainObj[lab].data[channel]=line_data;
  mainObj[lab].lines[channel] = my_line;
  });

}


connection.onmessage = function(event) {

    var newData = JSON.parse(event.data);
    // if no error found, update the channels specified in the lab's dict.
    //
    // if newData.error=true, update the channels using the -0.5 value, and
    // change the connection_text style to "error"
    if(!newData.error){
      mainObj[newData.user].analogchannels.forEach(function(channel){
        add_data_to_buffer(mainObj[newData.user].data[channel],newData[channel]);
        redrawWithoutAnimation(mainObj[newData.user].lines[channel],
          mainObj[newData.user].data[channel]);
          mainObj[newData.user].lines[channel].classed('disconnected',false)
      })

      mainObj[newData.user].connection_text.classed("error",false);
      }
    else{
      mainObj[newData.user].analogchannels.forEach(function(channel){
        add_data_to_buffer(mainObj[newData.user].data[channel],-0.5);
        redrawWithoutAnimation(mainObj[newData.user].lines[channel],
          mainObj[newData.user].data[channel]);
          mainObj[newData.user].lines[channel].classed('disconnected',false)
      })

      mainObj[newData.user].connection_text.classed("error",true);
      }

  }

</script>
</body>
</html>
